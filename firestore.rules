rules_version = '2'
service cloud.firestore {
  	match /databases/{database}/documents {
    	// Function to check if user is authorized
    	function isAuthorized() {
      		return request.auth.uid != null
    	}

		// Calls
   	match /calls/{callId} {
			function callParticipant(resource) {
				return resource.data.creator == request.auth.uid || resource.data.target == request.auth.uid
			}
			allow read, write: if isAuthorized() && callParticipant(resource)
      allow create, list: if isAuthorized()

			function inCall(callId, uid) {
      	let data = get(/databases/$(database)/documents/calls/$(callId)).data;
      	return data.creator == uid || data.target == uid
      }

			// Offer Canidates
			match /offerCandidates/{offerCandidatesId} {
				allow read, write: if isAuthorized() && inCall(callId, request.auth.uid)
			}

			// Answer Canidates
			match /answerCandidates/{answerCandidatesId} {
				allow read,write: if isAuthorized() && inCall(callId, request.auth.uid)
			}
   	}
 	}
}